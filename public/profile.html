<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>My Bookings ¬∑ Student‚ÄìTeacher Booking</title>
	<link rel="stylesheet" href="/profile.css" />
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.7.2/css/all.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.7.2/css/sharp-solid.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.7.2/css/sharp-regular.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.7.2/css/sharp-light.css">
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.7.2/css/duotone.css" />
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.7.2/css/brands.css" />
</head>
<body>
	<header class="container">
		<div class="img-container">
            <img src="./images/logo.png" alt="Logo" height="60" width="60">
            <h1 style="color: black;">Edu-Mentors</h1>
        </div>
		<nav class="nav"></nav>
	</header>
	<h1 style="color: black; font-size: 24px; font-weight: 700; margin-bottom: 16px; margin-left: 246px; margin-top: 16px;">My Bookings</h1>
	<main class="container">
		<section id="summary" class="card" style="margin-bottom: 16px;"></section>
		<section class="card">
			<h2>Recent Bookings</h2>
			<div id="list" class="bookings-grid"></div>
		</section>
	</main>
	<footer>
        <div class="footer-content">
            <div class="footer-logo">
                <img src="./images/logo.png" alt="Edu-Mentors Logo" height="40" width="40">
                <span style="font-family: 'Comfortaa', cursive; font-size: 1.2em;">Edu-Mentors</span>
            </div>
            
            <div class="footer-social">
                <a href="#"><i class="fab fa-facebook-f"></i></a>
                <a href="#"><i class="fab fa-twitter"></i></a>
                <a href="#"><i class="fab fa-linkedin-in"></i></a>
                <a href="#"><i class="fab fa-instagram"></i></a>
            </div>
            <div class="footer-copy">
                <p>&copy; 2024 Edu-Mentors. All rights
                    reserved.</p>
            </div>
        </div>
        <div class="footer-credits">
            <p>Designed by <a href="" target="_blank">Sandeep Bhukya</a></p>
        </div>
        </div>

    </footer>

	<!-- Booking Details Modal -->
	<div id="booking-modal" class="modal" style="display: none;">
		<div class="modal-content">
			<div class="modal-header">
				<h3 id="modal-title">Booking Details</h3>
				<button class="modal-close" onclick="closeModal()">&times;</button>
			</div>
			<div id="modal-body" class="modal-body">
				<!-- Content will be populated by JavaScript -->
			</div>
		</div>
	</div>

	<script src="/auth.js" defer></script>
	<script>
		let currentBookings = [];

		async function fetchMe(){
			const token = localStorage.getItem('token');
			const res = await fetch('/api/me',{headers:{Authorization:'Bearer '+token}});
			const data = await res.json();
			if(!res.ok) throw new Error(data.error||'Unauthorized');
			return data;
		}

		async function fetchMyBookings(){
			const token = localStorage.getItem('token');
			const res = await fetch('/api/my-bookings',{headers:{Authorization:'Bearer '+token}});
			const data = await res.json();
			if(!res.ok) throw new Error(data.error||'Failed');
			return data;
		}

		function renderSummary(me, bookings){
			const el = document.getElementById('summary');
			const count = bookings.length;
			const amount = me.role==='student' ? (me.stats?.totalSpend||0) : (me.stats?.totalEarnings||0);
			el.innerHTML = `
				<div style="display:flex; align-items:center; gap:12px;">
					<img src="./images/user-logo.png" alt="User Logo" width="75" height="75" style="border-radius:12px; object-fit:cover;"/>
					<div>
						<div class="title">${me.name}</div>
						<div class="sub">${me.email} ¬∑ ${me.role}</div>
					</div>
				</div>
				<div style="display:flex; gap:8px;">
					<span class="pill clickable" onclick="showBookingStats()" style="cursor: pointer;">Bookings: ${count}</span>
					<span class="pill">${me.role==='student' ? 'Spent' : 'Earnings'}: $${amount.toFixed(2)}</span>
				</div>
			`;
		}

		function showBookingStats() {
			if (currentBookings.length === 0) {
				alert('No bookings to show details for.');
				return;
			}

			const upcoming = currentBookings.filter(b => getSessionStatus(b).status === 'upcoming').length;
			const completed = currentBookings.filter(b => getSessionStatus(b).status === 'completed').length;
			const ongoing = currentBookings.filter(b => getSessionStatus(b).status === 'ongoing').length;
			const starting = currentBookings.filter(b => getSessionStatus(b).status === 'starting').length;

			const modal = document.getElementById('booking-modal');
			const modalBody = document.getElementById('modal-body');
			
			modalBody.innerHTML = `
				<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 16px; margin-bottom: 20px;">
					<div style="text-align: center; padding: 12px; background: rgba(14,165,233,0.1); border-radius: 8px;">
						<div style="font-size: 24px; font-weight: 700; color: #7dd3fc;">${upcoming}</div>
						<div style="font-size: 12px; color: var(--muted);">Upcoming</div>
					</div>
					<div style="text-align: center; padding: 12px; background: rgba(245,158,11,0.1); border-radius: 8px;">
						<div style="font-size: 24px; font-weight: 700; color: #fbbf24;">${starting}</div>
						<div style="font-size: 12px; color: var(--muted);">Starting Soon</div>
					</div>
					<div style="text-align: center; padding: 12px; background: rgba(59,130,246,0.1); border-radius: 8px;">
						<div style="font-size: 24px; font-weight: 700; color: #60a5fa;">${ongoing}</div>
						<div style="font-size: 12px; color: var(--muted);">In Progress</div>
					</div>
					<div style="text-align: center; padding: 12px; background: rgba(34,197,94,0.1); border-radius: 8px;">
						<div style="font-size: 24px; font-weight: 700; color: #4ade80;">${completed}</div>
						<div style="font-size: 12px; color: var(--muted);">Completed</div>
					</div>
				</div>
				<div style="text-align: center;">
					<button class="btn" onclick="closeModal()">Close</button>
				</div>
			`;
			
			modal.style.display = 'flex';
		}

		function closeModal() {
			document.getElementById('booking-modal').style.display = 'none';
		}

		// Close modal when clicking outside
		window.onclick = function(event) {
			const modal = document.getElementById('booking-modal');
			if (event.target === modal) {
				closeModal();
			}
		}

		function formatDate(dateStr) {
			const date = new Date(dateStr);
			return date.toLocaleDateString('en-US', { 
				weekday: 'short', 
				month: 'short', 
				day: 'numeric',
				year: 'numeric'
			});
		}

		function getSessionStatus(booking) {
			const now = new Date();
			const bookingDate = new Date(booking.date + 'T' + booking.time);
			const diffMs = bookingDate - now;
			const diffMins = Math.floor(diffMs / (1000 * 60));
			
			if (diffMins < -60) return { status: 'completed', text: 'Completed' };
			if (diffMins < 0) return { status: 'ongoing', text: 'In Progress' };
			if (diffMins < 15) return { status: 'starting', text: 'Starting Soon' };
			return { status: 'upcoming', text: 'Upcoming' };
		}

		function renderList(me, bookings){
			currentBookings = bookings; // Store for stats
			const list = document.getElementById('list');
			list.innerHTML = '';
			
			if (bookings.length === 0) {
				list.innerHTML = `
					<div style="text-align: center; padding: 40px; color: var(--muted);">
						<div style="font-size: 48px; margin-bottom: 16px;">üìö</div>
						<div class="title">No bookings yet</div>
						<div class="sub">Start by booking a session with a teacher</div>
						<a href="/index.html" class="btn" style="margin-top: 16px; display: inline-block;">Book Now</a>
					</div>
				`;
				return;
			}

			for(const b of bookings){
				const other = me.role==='student' ? b.teacher : b.student;
				const sessionStatus = getSessionStatus(b);
				const card = document.createElement('div');
				card.className = 'booking-card';
				card.innerHTML = `
					<div class="booking-header">
						<img src="${other?.imageUrl || '/images/default-avatar.svg'}" alt="${other?.name}" width="64" height="64" style="border-radius:12px; object-fit:cover;"/>
						<div class="booking-info">
							<div class="title">${other?.name || 'Unknown'}</div>
							<div class="sub">${me.role==='student' ? (other?.subject || '') : (other?.email || '')}</div>
							<div class="booking-date">${formatDate(b.date)} at ${b.time}</div>
						</div>
						<div class="booking-actions">
							<div class="pill ${sessionStatus.status}">${sessionStatus.text}</div>
							<button class="btn-delete" onclick="deleteBooking('${b._id}')" title="Delete booking">üóëÔ∏è</button>
						</div>
					</div>
					<div class="booking-details">
						<div class="price">$${(b.teacher?.price||0).toFixed(2)}</div>
						${b.note ? `<div class="note">${b.note}</div>` : ''}
						${sessionStatus.status === 'starting' ? `<div class="timer" id="timer-${b._id}">Starting in <span id="countdown-${b._id}">--</span></div>` : ''}
					</div>
				`;
				list.appendChild(card);
			}

			// Start timers for upcoming sessions
			startTimers(bookings);
		}

		function startTimers(bookings) {
			bookings.forEach(booking => {
				const sessionStatus = getSessionStatus(booking);
				if (sessionStatus.status === 'starting') {
					const countdownEl = document.getElementById(`countdown-${booking._id}`);
					if (countdownEl) {
						const updateTimer = () => {
							const now = new Date();
							const bookingDate = new Date(booking.date + 'T' + booking.time);
							const diffMs = bookingDate - now;
							const diffMins = Math.floor(diffMs / (1000 * 60));
							
							if (diffMins <= 0) {
								countdownEl.textContent = 'Starting now!';
								return;
							}
							
							countdownEl.textContent = `${diffMins}m`;
							setTimeout(updateTimer, 60000); // Update every minute
						};
						updateTimer();
					}
				}
			});
		}

		async function deleteBooking(bookingId) {
			if (!confirm('Are you sure you want to delete this booking?')) return;
			
			try {
				const token = localStorage.getItem('token');
				const res = await fetch(`/api/bookings/${bookingId}`, {
					method: 'DELETE',
					headers: { Authorization: 'Bearer ' + token }
				});
				
				if (!res.ok) throw new Error('Failed to delete booking');
				
				// Refresh the page to show updated list
				location.reload();
			} catch (err) {
				alert('Failed to delete booking: ' + err.message);
			}
		}

		async function init(){
			try{
				const me = await fetchMe();
				const bookings = await fetchMyBookings();
				renderSummary(me, bookings);
				renderList(me, bookings);
			}catch(err){
				location.replace('/login.html?next=' + encodeURIComponent('/profile.html'));
			}
		}

		init();
	</script>
</body>
</html>


